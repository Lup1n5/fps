<!DOCTYPE html>
<html>
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyA4IHTB7Efpj1isFTg96w2A0HMuUaDgQGo",
  authDomain: "game-f5d82.firebaseapp.com",
  projectId: "game-f5d82",
  storageBucket: "game-f5d82.appspot.com",
  messagingSenderId: "464100027811",
  appId: "1:464100027811:web:8e82c5edc86aa190343e16",
  measurementId: "G-MVRLFND7RE"
};
firebase.initializeApp(firebaseConfig);

var db = firebase.database();

var player;
var bullets = [];
var score = 0;
var gameState = 'start';

function drawTitleScreen() {
  background(255);
  
  // Draw game title
  fill('black');
  textSize(48);
  textAlign(CENTER, CENTER);
  text('My Cool Game', width / 2, height / 2 - 50);
  
  // Draw start button
  fill('blue');
  rect(width / 2 - 50, height / 2 + 50, 100, 50);
  
  // Draw start text
  fill('white');
  textSize(24);
  text('Start', width / 2, height / 2 + 75);
}

function keyPressed() {
   if(keyCode === UP_ARROW || key === 'w') {
     player.y -=10;
   } else if(keyCode === DOWN_ARROW || key === 's') {
     player.y +=10;
   } else if(keyCode === LEFT_ARROW || key === 'a') {
     player.x -=10;
   } else if(keyCode === RIGHT_ARROW || key === 'd') {
     player.x +=10;
   }
}

function mouseClicked() {
   if(gameState === 'start') {
    // Check if start button is clicked
    if(mouseX > width / 2 - 50 && mouseX < width / 2 + 50 &&
       mouseY > height / 2 + 50 && mouseY < height / 2 + 100) {
      gameState = 'play';
    }
   } else if(gameState === 'play') {
     var bullet = createVector(player.x +25, player.y);
     bullet.timestamp = Date.now();
     bullet.dir = createVector(mouseX - player.x, mouseY - player.y);
     bullet.dir.normalize();
     bullets.push(bullet);
     db.ref('game/bullet' + (bullets.length -1)).set({
       x: bullet.x,
       y: bullet.y,
       timestamp: bullet.timestamp,
       dirx: bullet.dir.x,
       diry: bullet.dir.y
     });
   }
}

function setup() {
   createCanvas(windowWidth, windowHeight);
   player = createVector(width /2, height -50);
}

function draw() {
   background(255);

   if(gameState === 'start') {
     drawTitleScreen();
   } else if(gameState === 'play') {

     // Draw player
     push();
     translate(player.x, player.y);
     rotate(atan2(mouseY - player.y, mouseX - player.x));
     rectMode(CENTER);
     rect(0,0,50,50);
     pop();

     // Draw bullets
     fill('red');
     for(var i = bullets.length -1; i >=0; i--) {
       var bullet = bullets[i];
       push();
       translate(bullet.x, bullet.y);
       rotate(atan2(bullet.dir.y, bullet.dir.x));
       rect(0,0,5,10);
       pop();
       bullet.x += bullet.dir.x *2;
       bullet.y += bullet.dir.y *2;
       if(bullet.x <0 || bullet.x > width || bullet.y <0 || bullet.y > height) {
         bullets.splice(i,1);
         db.ref('game/bullet' + i).remove();
       }
     }

     // Display score
     fill('black');
     textSize(24);
     text('Score: ' + score,10,30);

     db.ref('game/player').set({
       x: player.x,
       y: player.y
     });

     // Update bullet positions in Firebase
     for(var i = bullets.length -1; i <=0; i--) {
       var bullet = bullets[i];
       if(Date.now() - bullet.timestamp >6000) {
         bullets.splice(i,1);
         db.ref('game/bullet' + i).remove();
       } else {
         db.ref('game/bullet' + i).set({
           x: bullet.x,
           y: bullet.y,
           timestamp: bullet.timestamp,
           dirx: bullet.dir.x,
           diry: bullet.dir.y
         });
       }
     }
   }
}
</script>
</body>
</html>
